<!DOCTYPE html>
<title>Elements the War</title>
<link rel="stylesheet" href="ui.css">
<script src="util.js"></script>
<div id="maindiv"></div>
<!-- Start with element select, once auth works save that as local setting. Otherwise go straight to deck management. No chat, standings is own url -->
<script>
function requestAuth(){
	xhrSend("teamlogin?"+mkAuthQuery(), createMainView, createLoginForm);
}
function mkAuthQuery(query){
	if (!query) query = {};
	query.e = localStorage.team;
	query.auth = localStorage.tauth;
	return mkQuery(query);
}
function xhrSend(url, onload, onerror){
	var xhr = new XMLHttpRequest();
	xhr.addEventListener("load", function(){
		if (this.status == 200) onload.call(this);
		else if (onerror) onerror.call(this);
	});
	if (onerror) xhr.addEventListener("error", onerror);
	xhr.open("GET", url, true);
	xhr.send();
}
function createLoginForm(){
	clearDiv(maindiv);
	var team = document.createElement("input");
	var pswd = document.createElement("input");
	team.placeholder="team";
	pswd.placeholder="auth";
	function onkeydown(e){
		if (e.keyCode == 13){
			localStorage.team = team.value;
			localStorage.tauth = pswd.value;
			requestAuth();
		}
	}
	team.addEventListener("keydown", onkeydown);
	pswd.addEventListener("keydown", onkeydown);
	maindiv.appendChild(team);
	maindiv.appendChild(pswd);
}
function createMainView(){
	clearDiv(maindiv);
	var viewVault = document.createElement("a");
	viewVault.href = "#";
	viewVault.appendChild(document.createTextNode("Vault"));
	viewVault.addEventListener("click", function(){
		xhrSend("viewvault?"+mkAuthQuery(), createViewVault);
	});
	var viewDecks = document.createElement("a");
	viewDecks.href = "#";
	viewDecks.appendChild(document.createTextNode("Decks"));
	viewDecks.addEventListener("click", function(){
		xhrSend("getdecks?"+mkAuthQuery(), createViewDecks);
	});
	maindiv.appendChild(viewVault);
	maindiv.appendChild(document.createElement("br"));
	maindiv.appendChild(viewDecks);
}
function createViewVault(){
	clearDiv(maindiv);
	var vault = JSON.parse(this.responseText);
	// Need to somewhere specify round & only allow setting vault during R0
	var vin = document.createElement("input");
	vin.placeholder = "Vault";
	vin.value = vault.cards;
	var vsubmit = document.createElement("input");
	vsubmit.type = "button";
	vsubmit.value = "Submit";
	vsubmit.addEventListener("click", function(){
		xhrSend("setvault?"+mkAuthQuery({cards:vin.value}), function(){
			var result = this.responseText;
			// Print errors, update deck image
		});
	});
	var vimg = mkDeck(vault.cards.split(" "));
	maindiv.appendChild(vin);
	maindiv.appendChild(vsubmit);
	maindiv.appendChild(document.createElement("br"));
	maindiv.appendChild(vimg);
}
function createViewDecks(){
	clearDiv(maindiv);
	var decks = JSON.parse(this.responseText);
	decks.forEach(function(deck){
		var main=deck[0], side=deck[1];
		document.appendChild(mkDeck(main.split(" ")));
		document.appendChild(mkDeck(side.split(" ")));
		// TODO inputs to modify decks
	});
}
requestAuth(); // Could skip straight to createLoginForm if auth doesn't exist, but I'd rather write this comment
</script>